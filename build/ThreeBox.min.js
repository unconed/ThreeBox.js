var MicroEvent=function(){};MicroEvent.prototype={bind:function(a,b){this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(b)},unbind:function(a,b){this._events=this._events||{};!1!==a in this._events&&this._events[a].splice(this._events[a].indexOf(b),1)},trigger:function(a){this._events=this._events||{};if(!1!==a in this._events)for(var b=0;b<this._events[a].length;b++)this._events[a][b].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger"],c=0;c<b.length;c++)a.prototype[b[c]]=MicroEvent.prototype[b[c]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);
function microAjax(a,b,c){this.bindFunction=function(a,b){return function(){return a.apply(b,[b])}};this.stateChange=function(){this.request.readyState==4&&this.callbackFunction(this.request.responseText)};this.getRequest=function(){return window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest?new XMLHttpRequest:false};this.postBody=c||"";this.callbackFunction=b;this.url=a;if(this.request=this.getRequest()){b=this.request;b.onreadystatechange=this.bindFunction(this.stateChange,
this);if(this.postBody!==""){b.open("POST",a,true);b.setRequestHeader("X-Requested-With","XMLHttpRequest");b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.setRequestHeader("Connection","close")}else b.open("GET",a,true);b.send(this.postBody)}}var \u03c0=Math.PI,\u03c4=2*\u03c0;(function(a){for(i in a)if(!window[i])throw"Error: ThreeBox requires "+a[i];})({THREE:"Three.js",tQuery:"tQuery.js (bundle)"});window.ThreeBox={};
window.threeBox=function(a,b){if(a&&!(a instanceof Node)){b=a;a=null}return tQuery.createWorld(b).threeBox(a,b)};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger","on","emit"],c=0;c<b.length;c++)a.prototype[b[c]]=MicroEvent.prototype[b[c]]};tQuery.World.prototype.on=tQuery.World.prototype.addEventListener;
tQuery.World.prototype.emit=tQuery.World.prototype.dispatchEvent;tQuery.World.register("threeBox",function(a,b){if(a&&!(a instanceof Node)){b=a;a=null}var c=a=a||document.body;if(a==document.body){c.style.margin=0;c.style.padding=0;c.style.overflow="hidden"}else{getComputedStyle(a);if(a.position=="static")a.position="relative"}this.appendTo(c);this.addThreeBox(a,b||{});return this});
tQuery.World.register("addThreeBox",function(a,b){console.assert(this.hasThreeBox()!==true);b=tQuery.extend(b,{cameraControls:false,cursor:true,controlClass:ThreeBox.OrbitControls,elementResize:true,fullscreen:true,screenshot:true,stats:true,scale:1});this.tRenderer().domElement.style.display="block";var c={};tQuery.data(this,"_threeBoxContext",c);var d=this.tCamera(),g=this.tRenderer();if(b.stats){c.stats=new Stats;c.stats.domElement.style.position="absolute";c.stats.domElement.style.left="10px";
c.stats.domElement.style.top="10px";a&&a.appendChild(c.stats.domElement);c.loopStats=function(){c.stats.update()};this.loop().hook(c.loopStats)}if(b.cameraControls){var e=this.loop(),f=this.render.bind(this);c.cameraControls=ThreeBox.OrbitControls.bind(d,a,b).on("change",function(){e._timerId||f()});this.setCameraControls(c.cameraControls)}if(b.elementResize)c.elementResize=ThreeBox.ElementResize.bind(g,d,a,b.scale).on("resize",function(a,b){this._opts.renderW=a;this._opts.renderH=b;this.emit("resize",
a,b)}.bind(this));if(b.cursor!==null)c.cursor=ThreeBox.Cursor.bind(a,b);if(b.screenshot)c.screenshot=THREEx.Screenshot.bindKey(g);if(b.fullscreen&&THREEx.FullScreen.available())c.fullscreen=THREEx.FullScreen.bindKey();c._$onDestroy=this.bind("destroy",function(){this.hasThreeBox()!==false&&this.removeThreeBox()});return this});tQuery.World.register("hasThreeBox",function(){return tQuery.data(this,"_threeBoxContext")===void 0?false:true});
tQuery.World.register("removeThreeBox",function(){var a=tQuery.data(this,"_threeBoxContext");if(a===void 0)return this;tQuery.removeData(this,"_threeBoxContext");this.unbind("destroy",this._$onDestroy);if(a.stats){document.body.removeChild(a.stats.domElement);this.loop().unhook(a.loopStats)}a.cameraControls&&this.removeCameraControls()&&a.cameraControls.stop();a.elementResize&&a.elementResize.unbind();a.cursor&&a.cursor.unbind();a.screenshot&&a.screenshot.unbind();a.fullscreen&&a.fullscreen.unbind()});
ThreeBox.ElementResize=function(a,b,c,d){this.scale=d||1;d=this.callback=function(){var d=Math.floor(c.offsetWidth),e=Math.floor(c.offsetHeight);a.domElement.style.position="absolute";a.domElement.style.width=d+"px";a.domElement.style.height=e+"px";var f=Math.floor(d/this.scale),h=Math.floor(e/this.scale);a.setSize(f,h);b.aspect=d/e;b.updateProjectionMatrix();this.emit("resize",f,h)}.bind(this);window.addEventListener("resize",d,false);c.addEventListener("resize",d,false);setTimeout(d,0)};
ThreeBox.ElementResize.bind=function(a,b,c,d){return new ThreeBox.ElementResize(a,b,c,d)};ThreeBox.ElementResize.prototype.scale=function(a){this.scale=a};ThreeBox.ElementResize.prototype.unbind=function(){window.removeEventListener("resize",callback);domElement.removeEventListener("resize",callback)};MicroEvent.mixin(ThreeBox.ElementResize);
ThreeBox.OrbitControls=function(a,b,c){this.element=b;this.camera=a;this.options=tQuery.extend(c,{phi:\u03c4/4,theta:0.3,orbit:2,lookAt:[0,0,0],speed:2});this.init();this.start();this.update()};
ThreeBox.OrbitControls.prototype={init:function(){this.width=this.element.offsetWidth;this.height=this.element.offsetHeight;this.phi=this.options.phi;this.theta=this.options.theta;this.orbit=this.options.orbit;this.speed=this.options.speed;this.lookAt=new THREE.Vector3;this.lookAt.set.apply(this.lookAt,this.options.lookAt||[])},start:function(){var a=this;this._mouseDown=function(a){this.drag=true;this.lastHover=this.origin={x:a.pageX,y:a.pageY};a.preventDefault()}.bind(this);this._mouseUp=function(){this.drag=
false}.bind(this);this._mouseMove=function(){if(a.drag){var b={x:event.pageX-a.origin.x,y:event.pageY-a.origin.y},c={x:event.pageX-a.lastHover.x,y:event.pageY-a.lastHover.y};a.lastHover={x:event.pageX,y:event.pageY};a.moved(a.origin,b,c)}}.bind(this);this.element.addEventListener("mousedown",this._mouseDown,false);document.addEventListener("mouseup",this._mouseUp,false);document.addEventListener("mousemove",this._mouseMove,false)},stop:function(){this.element.removeEventListener("mousedown",this._mouseDown);
document.removeEventListener("mouseup",this._mouseUp);document.removeEventListener("mousemove",this._mouseMove)},moved:function(a,b,c){this.phi=this.phi+c.x*this.speed/this.width;this.theta=Math.min(\u03c0/2,Math.max(-\u03c0/2,this.theta+c.y*this.speed/this.height));this.emit("change")},update:function(){this.camera.position.x=Math.cos(this.phi)*Math.cos(this.theta)*this.orbit;this.camera.position.y=Math.sin(this.theta)*this.orbit;this.camera.position.z=Math.sin(this.phi)*Math.cos(this.theta)*this.orbit;
this.camera.position.addSelf(this.lookAt);this.camera.lookAt(this.lookAt)}};ThreeBox.OrbitControls.bind=function(a,b,c){return new ThreeBox.OrbitControls(a,b,c)};MicroEvent.mixin(ThreeBox.OrbitControls);
ThreeBox.Cursor=function(a,b){function c(){if(!e)a.style.cursor=d;clearTimeout(g);e=false;g=setTimeout(function(){e=true;a.style.cursor="none"},f)}var d=b.cameraControls?"move":"default",g=null,e=false,f=2E3;if(b.cursor)a.style.cursor=d;else{a.addEventListener("mousemove",c);a.style.cursor="none"}return{unbind:function(){a.removeEventListener("mousemove",c)}}};ThreeBox.Cursor.bind=function(a,b){return ThreeBox.Cursor(a,b)};
ThreeBox.preload=function(a,b){if(a instanceof Function){b=a;a=[]}var a=typeof a=="string"?[a]:a,c=a.length;_.each(a,function(a){new microAjax(a,function(a){var d=document.createElement("div");d.innerHTML=a;document.body.appendChild(d);--c==0&&b()})})};
